<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ† metals_dashboard</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: system-ui, -apple-system, sans-serif;
        }
        body {
            background: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            padding: 16px;
            max-width: 600px;
            margin: 0 auto;
        }
        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 24px;
        }
        .title {
            font-size: 24px;
            font-weight: bold;
        }
        .last-update {
            font-size: 12px;
            color: var(--tg-theme-hint-color, #999999);
        }
        .price-card {
            background: var(--tg-theme-secondary-bg-color, #f0f0f0);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 16px;
            transition: all 0.3s ease;
        }
        .price-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        .metal-name {
            font-size: 18px;
            font-weight: 600;
        }
        .price {
            font-size: 24px;
            font-weight: bold;
            direction: ltr;
        }
        .change {
            font-size: 14px;
            padding: 4px 8px;
            border-radius: 20px;
        }
        .change.positive { background: #e6f7e6; color: #00a86b; }
        .change.negative { background: #ffe6e6; color: #ff4d4d; }
        
        .menu-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin: 24px 0;
        }
        .menu-item {
            background: var(--tg-theme-button-color, #40a7e3);
            color: var(--tg-theme-button-text-color, #ffffff);
            padding: 16px;
            border-radius: 14px;
            text-align: center;
            font-weight: 600;
            cursor: pointer;
            transition: opacity 0.2s;
        }
        .menu-item:active {
            opacity: 0.8;
        }
        .menu-item.secondary {
            background: var(--tg-theme-secondary-bg-color, #f0f0f0);
            color: var(--tg-theme-text-color, #000000);
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .modal-content {
            background: var(--tg-theme-bg-color, #ffffff);
            border-radius: 24px;
            padding: 24px;
            width: 100%;
            max-width: 400px;
            max-height: 80vh;
            overflow-y: auto;
        }
        .input-group {
            margin-bottom: 16px;
        }
        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }
        .input-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--tg-theme-hint-color, #dddddd);
            border-radius: 12px;
            font-size: 16px;
            background: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
        }
        .button {
            background: var(--tg-theme-button-color, #40a7e3);
            color: var(--tg-theme-button-text-color, #ffffff);
            border: none;
            padding: 14px 24px;
            border-radius: 14px;
            font-weight: 600;
            font-size: 16px;
            width: 100%;
            cursor: pointer;
            margin-bottom: 8px;
        }
        .button.danger {
            background: #ff4d4d;
        }
        .holdings-list {
            margin: 16px 0;
        }
        .holding-item {
            background: var(--tg-theme-secondary-bg-color, #f0f0f0);
            padding: 12px;
            border-radius: 12px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .profit-positive { color: #00a86b; }
        .profit-negative { color: #ff4d4d; }
        .hidden { display: none; }
        .error-message {
            background: #fff3f3;
            color: #d32f2f;
            padding: 12px;
            border-radius: 12px;
            margin: 16px 0;
            text-align: center;
            border: 1px solid #ffcdd2;
        }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--tg-theme-button-color, #40a7e3);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 8px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="header">
        <span class="title">ğŸ† metals_dashboard</span>
        <span class="last-update" id="lastUpdate">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ...</span>
    </div>

    <!-- Ú©Ø§Ø±Øªâ€ŒÙ‡Ø§ÛŒ Ù‚ÛŒÙ…Øª -->
    <div class="price-card" id="goldCard">
        <div class="price-row">
            <span class="metal-name">ğŸ… Ø·Ù„Ø§</span>
            <span class="change" id="goldChange">0%</span>
        </div>
        <div class="price-row">
            <span>Û²Û´ Ø¹ÛŒØ§Ø±</span>
            <span class="price" id="goldPrice24">---</span>
        </div>
        <div class="price-row">
            <span>Û±Û¸ Ø¹ÛŒØ§Ø±</span>
            <span class="price" id="goldPrice18">---</span>
        </div>
    </div>

    <div class="price-card" id="silverCard">
        <div class="price-row">
            <span class="metal-name">ğŸ¥ˆ Ù†Ù‚Ø±Ù‡</span>
            <span class="change" id="silverChange">0%</span>
        </div>
        <div class="price-row">
            <span>Ù‚ÛŒÙ…Øª</span>
            <span class="price" id="silverPrice">---</span>
        </div>
    </div>

    <!-- Ù…Ù†ÙˆÛŒ Ø§ØµÙ„ÛŒ -->
    <div class="menu-grid">
        <div class="menu-item" onclick="showPortfolio()">ğŸ’¼ Ù¾Ø±ØªÙÙˆÛŒ</div>
        <div class="menu-item" onclick="showProfit()">ğŸ’° Ø³ÙˆØ¯/Ø²ÛŒØ§Ù†</div>
        <div class="menu-item" onclick="showAlerts()">ğŸ”” Ù‡Ø´Ø¯Ø§Ø±Ù‡Ø§</div>
        <div class="menu-item" onclick="showSettings()">âš™ï¸ ØªÙ†Ø¸ÛŒÙ…Ø§Øª</div>
    </div>

    <!-- Ù…ÙˆØ¯Ø§Ù„ Ù¾Ø±ØªÙÙˆÛŒ -->
    <div id="portfolioModal" class="modal">
        <div class="modal-content">
            <h2 style="margin-bottom: 20px;">ğŸ’¼ Ù…Ø¯ÛŒØ±ÛŒØª Ù¾Ø±ØªÙÙˆÛŒ</h2>
            
            <div class="menu-grid" style="grid-template-columns: 1fr 1fr; margin: 0 0 16px 0;">
                <div class="menu-item secondary" onclick="showAddGold()">â• Ø§ÙØ²ÙˆØ¯Ù† Ø·Ù„Ø§</div>
                <div class="menu-item secondary" onclick="showAddSilver()">â• Ø§ÙØ²ÙˆØ¯Ù† Ù†Ù‚Ø±Ù‡</div>
            </div>

            <div id="holdingsList" class="holdings-list">
                <!-- Ù„ÛŒØ³Øª Ø¯Ø§Ø±Ø§ÛŒÛŒâ€ŒÙ‡Ø§ Ø¨Ø§ JavaScript Ù¾Ø± Ù…ÛŒâ€ŒØ´ÙˆØ¯ -->
            </div>

            <button class="button danger" onclick="clearPortfolio()" style="margin-top: 16px;">ğŸ—‘ Ø­Ø°Ù Ù‡Ù…Ù‡</button>
            <button class="button" onclick="closeModal('portfolioModal')">ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª</button>
        </div>
    </div>

    <!-- Ù…ÙˆØ¯Ø§Ù„ Ø§ÙØ²ÙˆØ¯Ù† Ø·Ù„Ø§ -->
    <div id="addGoldModal" class="modal">
        <div class="modal-content">
            <h2 style="margin-bottom: 20px;">â• Ø§ÙØ²ÙˆØ¯Ù† Ø·Ù„Ø§</h2>
            
            <div class="input-group">
                <label>Ù…Ù‚Ø¯Ø§Ø± (Ú¯Ø±Ù…)</label>
                <input type="number" id="goldAmount" placeholder="Ù…Ø«Ù„Ø§Ù‹ Û±Û°">
            </div>
            
            <div class="input-group">
                <label>Ù‚ÛŒÙ…Øª Ø®Ø±ÛŒØ¯ (ØªÙˆÙ…Ø§Ù†)</label>
                <input type="number" id="goldPrice" placeholder="Ù…Ø«Ù„Ø§Ù‹ Û³Û²Û°Û°Û°Û°Û°">
            </div>

            <button class="button" onclick="addGold()">âœ… Ø«Ø¨Øª</button>
            <button class="button secondary" onclick="closeModal('addGoldModal'); showPortfolio()">ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª</button>
        </div>
    </div>

    <!-- Ù…ÙˆØ¯Ø§Ù„ Ø§ÙØ²ÙˆØ¯Ù† Ù†Ù‚Ø±Ù‡ -->
    <div id="addSilverModal" class="modal">
        <div class="modal-content">
            <h2 style="margin-bottom: 20px;">â• Ø§ÙØ²ÙˆØ¯Ù† Ù†Ù‚Ø±Ù‡</h2>
            
            <div class="input-group">
                <label>Ù…Ù‚Ø¯Ø§Ø± (Ú¯Ø±Ù…)</label>
                <input type="number" id="silverAmount" placeholder="Ù…Ø«Ù„Ø§Ù‹ ÛµÛ°Û°">
            </div>
            
            <div class="input-group">
                <label>Ù‚ÛŒÙ…Øª Ø®Ø±ÛŒØ¯ (ØªÙˆÙ…Ø§Ù†)</label>
                <input type="number" id="silverBuyPrice" placeholder="Ù…Ø«Ù„Ø§Ù‹ Û´ÛµÛ°Û°Û°">
            </div>

            <button class="button" onclick="addSilver()">âœ… Ø«Ø¨Øª</button>
            <button class="button secondary" onclick="closeModal('addSilverModal'); showPortfolio()">ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª</button>
        </div>
    </div>

    <!-- Ù…ÙˆØ¯Ø§Ù„ Ø³ÙˆØ¯/Ø²ÛŒØ§Ù† -->
    <div id="profitModal" class="modal">
        <div class="modal-content">
            <h2 style="margin-bottom: 20px;">ğŸ’° Ú¯Ø²Ø§Ø±Ø´ Ø³ÙˆØ¯/Ø²ÛŒØ§Ù†</h2>
            
            <div id="profitGold" style="margin-bottom: 16px; padding: 12px; background: var(--tg-theme-secondary-bg-color); border-radius: 12px;">
                <!-- Ø³ÙˆØ¯ Ø·Ù„Ø§ -->
            </div>
            
            <div id="profitSilver" style="margin-bottom: 16px; padding: 12px; background: var(--tg-theme-secondary-bg-color); border-radius: 12px;">
                <!-- Ø³ÙˆØ¯ Ù†Ù‚Ø±Ù‡ -->
            </div>

            <button class="button" onclick="closeModal('profitModal')">ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª</button>
        </div>
    </div>

    <!-- Ù…ÙˆØ¯Ø§Ù„ Ù‡Ø´Ø¯Ø§Ø±Ù‡Ø§ -->
    <div id="alertsModal" class="modal">
        <div class="modal-content">
            <h2 style="margin-bottom: 20px;">ğŸ”” ØªÙ†Ø¸ÛŒÙ… Ù‡Ø´Ø¯Ø§Ø±</h2>
            
            <div style="margin-bottom: 20px;">
                <h3>ğŸ… Ø·Ù„Ø§</h3>
                <div class="input-group">
                    <label>Ø­Ø¯Ø§Ù‚Ù„ Ù‚ÛŒÙ…Øª</label>
                    <input type="number" id="goldMin" value="2000000">
                </div>
                <div class="input-group">
                    <label>Ø­Ø¯Ø§Ú©Ø«Ø± Ù‚ÛŒÙ…Øª</label>
                    <input type="number" id="goldMax" value="5000000">
                </div>
                <div style="display: flex; align-items: center; margin-bottom: 16px;">
                    <input type="checkbox" id="goldEnabled" checked style="margin-left: 8px;">
                    <label>ÙØ¹Ø§Ù„ Ø¨Ø§Ø´Ø¯</label>
                </div>
            </div>

            <div style="margin-bottom: 20px;">
                <h3>ğŸ¥ˆ Ù†Ù‚Ø±Ù‡</h3>
                <div class="input-group">
                    <label>Ø­Ø¯Ø§Ù‚Ù„ Ù‚ÛŒÙ…Øª</label>
                    <input type="number" id="silverMin" value="30000">
                </div>
                <div class="input-group">
                    <label>Ø­Ø¯Ø§Ú©Ø«Ø± Ù‚ÛŒÙ…Øª</label>
                    <input type="number" id="silverMax" value="80000">
                </div>
                <div style="display: flex; align-items: center; margin-bottom: 16px;">
                    <input type="checkbox" id="silverEnabled" checked style="margin-left: 8px;">
                    <label>ÙØ¹Ø§Ù„ Ø¨Ø§Ø´Ø¯</label>
                </div>
            </div>

            <button class="button" onclick="saveAlerts()">ğŸ’¾ Ø°Ø®ÛŒØ±Ù‡</button>
            <button class="button secondary" onclick="closeModal('alertsModal')">ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª</button>
        </div>
    </div>

    <!-- Ù…ÙˆØ¯Ø§Ù„ ØªÙ†Ø¸ÛŒÙ…Ø§Øª -->
    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <h2 style="margin-bottom: 20px;">âš™ï¸ ØªÙ†Ø¸ÛŒÙ…Ø§Øª</h2>
            
            <div class="input-group">
                <label>ÙØ§ØµÙ„Ù‡ Ú¯Ø²Ø§Ø±Ø´ (Ø¯Ù‚ÛŒÙ‚Ù‡)</label>
                <select id="reportInterval">
                    <option value="1">Û± Ø¯Ù‚ÛŒÙ‚Ù‡</option>
                    <option value="5" selected>Ûµ Ø¯Ù‚ÛŒÙ‚Ù‡</option>
                    <option value="10">Û±Û° Ø¯Ù‚ÛŒÙ‚Ù‡</option>
                    <option value="15">Û±Ûµ Ø¯Ù‚ÛŒÙ‚Ù‡</option>
                    <option value="30">Û³Û° Ø¯Ù‚ÛŒÙ‚Ù‡</option>
                </select>
            </div>

            <div class="input-group">
                <label>Ù†ÙˆØ¹ Ú¯Ø²Ø§Ø±Ø´</label>
                <select id="reportType">
                    <option value="both" selected>Ø·Ù„Ø§ Ùˆ Ù†Ù‚Ø±Ù‡</option>
                    <option value="gold">ÙÙ‚Ø· Ø·Ù„Ø§</option>
                    <option value="silver">ÙÙ‚Ø· Ù†Ù‚Ø±Ù‡</option>
                </select>
            </div>

            <button class="button" onclick="saveSettings()">ğŸ’¾ Ø°Ø®ÛŒØ±Ù‡</button>
            <button class="button secondary" onclick="closeModal('settingsModal')">ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª</button>
        </div>
    </div>

    <script>
        // ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø§ÙˆÙ„ÛŒÙ‡ ØªÙ„Ú¯Ø±Ø§Ù…
        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.ready();

        // ==================== Ù…Ø¯ÛŒØ±ÛŒØª Ø¯ÛŒØªØ§Ø¨ÛŒØ³ Ù…Ø­Ù„ÛŒ ====================
        const STORAGE_KEYS = {
            PORTFOLIO: 'metals_portfolio',
            ALERTS: 'metals_alerts',
            SETTINGS: 'metals_settings'
        };

        let portfolio = { holdings: [] };
        let alerts = {
            gold: { enabled: true, min: 2000000, max: 5000000 },
            silver: { enabled: true, min: 30000, max: 80000 }
        };
        let settings = {
            reportInterval: 5,
            reportType: 'both'
        };

        // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§
        function loadData() {
            try {
                const savedPortfolio = localStorage.getItem(STORAGE_KEYS.PORTFOLIO);
                if (savedPortfolio) portfolio = JSON.parse(savedPortfolio);
                
                const savedAlerts = localStorage.getItem(STORAGE_KEYS.ALERTS);
                if (savedAlerts) alerts = JSON.parse(savedAlerts);
                
                const savedSettings = localStorage.getItem(STORAGE_KEYS.SETTINGS);
                if (savedSettings) settings = JSON.parse(savedSettings);
            } catch (e) {
                console.error('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ:', e);
            }
        }

        // Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§
        function savePortfolio() {
            localStorage.setItem(STORAGE_KEYS.PORTFOLIO, JSON.stringify(portfolio));
            updateUI();
        }

        function saveAlertsData() {
            localStorage.setItem(STORAGE_KEYS.ALERTS, JSON.stringify(alerts));
        }

        function saveSettingsData() {
            localStorage.setItem(STORAGE_KEYS.SETTINGS, JSON.stringify(settings));
        }

        // ==================== Ø¯Ø±ÛŒØ§ÙØª Ù‚ÛŒÙ…Øª ====================
        let lastPrices = { gold: null, silver: null, goldChange: 0, silverChange: 0 };
        let retryCount = 0;
        const MAX_RETRIES = 3;
        
        async function fetchPrices() {
            try {
                document.getElementById('lastUpdate').innerHTML = '<span class="loading"></span> Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª...';
                
                // Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ú†Ù†Ø¯ Ù¾Ø±ÙˆÚ©Ø³ÛŒ Ù…Ø®ØªÙ„Ù Ø¨Ø±Ø§ÛŒ Ø§ÙØ²Ø§ÛŒØ´ Ø´Ø§Ù†Ø³ Ù…ÙˆÙÙ‚ÛŒØª
                const proxies = [
                    'https://api.allorigins.win/raw?url=',
                    'https://corsproxy.io/?',
                    'https://thingproxy.freeboard.io/fetch/'
                ];
                
                // Ø§Ù…ØªØ­Ø§Ù† Ú©Ø±Ø¯Ù† Ù¾Ø±ÙˆÚ©Ø³ÛŒâ€ŒÙ‡Ø§ Ø¨Ù‡ ØªØ±ØªÛŒØ¨
                let goldData = null;
                let silverData = null;
                
                for (const proxy of proxies) {
                    try {
                        if (!goldData) {
                            const goldRes = await fetch(proxy + encodeURIComponent('https://inv.charisma.ir/pub/Plans/Gold'));
                            if (goldRes.ok) {
                                goldData = await goldRes.json();
                            }
                        }
                        
                        if (!silverData) {
                            const silverRes = await fetch(proxy + encodeURIComponent('https://inv.charisma.ir/pub/Plans/silver'));
                            if (silverRes.ok) {
                                silverData = await silverRes.json();
                            }
                        }
                        
                        if (goldData && silverData) break;
                    } catch (e) {
                        console.log('Ù¾Ø±ÙˆÚ©Ø³ÛŒ Ù†Ø§Ù…ÙˆÙÙ‚:', proxy);
                    }
                }

                if (goldData?.isSuccess) {
                    const current = Math.floor(goldData.data.latestIndexPrice.index / 10);
                    const prev = Math.floor(goldData.data.prevIndexPrice.index / 10);
                    
                    lastPrices.gold = current;
                    lastPrices.goldChange = prev ? ((current - prev) / prev * 100).toFixed(2) : 0;
                    retryCount = 0;
                }

                if (silverData?.isSuccess) {
                    const current = Math.floor(silverData.data.latestIndexPrice.index / 10);
                    const prev = Math.floor(silverData.data.prevIndexPrice.index / 10);
                    
                    lastPrices.silver = current;
                    lastPrices.silverChange = prev ? ((current - prev) / prev * 100).toFixed(2) : 0;
                    retryCount = 0;
                }

                updatePriceDisplay();
                checkAlerts();
                
                const now = new Date();
                document.getElementById('lastUpdate').innerText = 'Ø¢Ø®Ø±ÛŒÙ† Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ: ' + now.toLocaleTimeString('fa-IR');
                
            } catch (error) {
                console.error('Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ù‚ÛŒÙ…Øª:', error);
                retryCount++;
                
                if (retryCount < MAX_RETRIES) {
                    document.getElementById('lastUpdate').innerHTML = `âš ï¸ Ø®Ø·Ø§ØŒ ØªÙ„Ø§Ø´ Ù…Ø¬Ø¯Ø¯ (${retryCount}/${MAX_RETRIES})...`;
                    setTimeout(fetchPrices, 5000);
                } else {
                    document.getElementById('lastUpdate').innerHTML = 'âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª';
                    
                    // Ù†Ù…Ø§ÛŒØ´ Ø®Ø·Ø§ Ø¨Ù‡ Ú©Ø§Ø±Ø¨Ø±
                    tg.showPopup({
                        title: 'âš ï¸ Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø·',
                        message: 'Ø¯Ø±ÛŒØ§ÙØª Ù‚ÛŒÙ…Øªâ€ŒÙ‡Ø§ Ø¨Ø§ Ù…Ø´Ú©Ù„ Ù…ÙˆØ§Ø¬Ù‡ Ø´Ø¯. Ù„Ø·ÙØ§Ù‹ ØµÙØ­Ù‡ Ø±Ø§ Ø±ÙØ±Ø´ Ú©Ù†ÛŒØ¯.',
                        buttons: [{ type: 'ok' }]
                    });
                }
            }
        }

        function updatePriceDisplay() {
            if (lastPrices.gold) {
                document.getElementById('goldPrice24').innerText = lastPrices.gold.toLocaleString();
                document.getElementById('goldPrice18').innerText = Math.floor(lastPrices.gold * 0.75).toLocaleString();
                
                const goldChangeElem = document.getElementById('goldChange');
                goldChangeElem.innerText = `${lastPrices.goldChange > 0 ? '+' : ''}${lastPrices.goldChange}%`;
                goldChangeElem.className = `change ${lastPrices.goldChange >= 0 ? 'positive' : 'negative'}`;
            }

            if (lastPrices.silver) {
                document.getElementById('silverPrice').innerText = lastPrices.silver.toLocaleString();
                
                const silverChangeElem = document.getElementById('silverChange');
                silverChangeElem.innerText = `${lastPrices.silverChange > 0 ? '+' : ''}${lastPrices.silverChange}%`;
                silverChangeElem.className = `change ${lastPrices.silverChange >= 0 ? 'positive' : 'negative'}`;
            }
        }

        function checkAlerts() {
            if (!lastPrices.gold || !lastPrices.silver) return;

            const alerts_messages = [];

            if (alerts.gold.enabled) {
                if (lastPrices.gold < alerts.gold.min) {
                    alerts_messages.push(`âš ï¸ Ø·Ù„Ø§ Ø¨Ù‡ ${lastPrices.gold.toLocaleString()} Ø±Ø³ÛŒØ¯ (Ú©Ù…ØªØ± Ø§Ø² ${alerts.gold.min.toLocaleString()})`);
                }
                if (lastPrices.gold > alerts.gold.max) {
                    alerts_messages.push(`âš ï¸ Ø·Ù„Ø§ Ø¨Ù‡ ${lastPrices.gold.toLocaleString()} Ø±Ø³ÛŒØ¯ (Ø¨ÛŒØ´ØªØ± Ø§Ø² ${alerts.gold.max.toLocaleString()})`);
                }
            }

            if (alerts.silver.enabled) {
                if (lastPrices.silver < alerts.silver.min) {
                    alerts_messages.push(`âš ï¸ Ù†Ù‚Ø±Ù‡ Ø¨Ù‡ ${lastPrices.silver.toLocaleString()} Ø±Ø³ÛŒØ¯ (Ú©Ù…ØªØ± Ø§Ø² ${alerts.silver.min.toLocaleString()})`);
                }
                if (lastPrices.silver > alerts.silver.max) {
                    alerts_messages.push(`âš ï¸ Ù†Ù‚Ø±Ù‡ Ø¨Ù‡ ${lastPrices.silver.toLocaleString()} Ø±Ø³ÛŒØ¯ (Ø¨ÛŒØ´ØªØ± Ø§Ø² ${alerts.silver.max.toLocaleString()})`);
                }
            }

            if (alerts_messages.length > 0) {
                tg.showPopup({
                    title: 'ğŸ”” Ù‡Ø´Ø¯Ø§Ø± Ù‚ÛŒÙ…Øª',
                    message: alerts_messages.join('\n\n'),
                    buttons: [{ type: 'ok' }]
                });
            }
        }

        // ==================== Ù…Ø¯ÛŒØ±ÛŒØª Ù¾Ø±ØªÙÙˆÛŒ ====================
        function showPortfolio() {
            const modal = document.getElementById('portfolioModal');
            updateHoldingsList();
            modal.style.display = 'flex';
        }

        function updateHoldingsList() {
            const listElem = document.getElementById('holdingsList');
            if (portfolio.holdings.length === 0) {
                listElem.innerHTML = '<p style="text-align: center; color: #999;">Ù¾Ø±ØªÙÙˆÛŒ Ø´Ù…Ø§ Ø®Ø§Ù„ÛŒ Ø§Ø³Øª</p>';
                return;
            }

            let html = '';
            portfolio.holdings.forEach(h => {
                html += `
                    <div class="holding-item">
                        <div>
                            ${h.metal === 'gold' ? 'ğŸ…' : 'ğŸ¥ˆ'} ${h.amount} Ú¯Ø±Ù…
                            <br>
                            <small>${h.price.toLocaleString()} ØªÙˆÙ…Ø§Ù†</small>
                        </div>
                        <button onclick="removeHolding('${h.id}')" style="background: none; border: none; color: #ff4d4d; font-size: 20px; cursor: pointer;">ğŸ—‘</button>
                    </div>
                `;
            });
            listElem.innerHTML = html;
        }

        function showAddGold() {
            closeModal('portfolioModal');
            document.getElementById('addGoldModal').style.display = 'flex';
        }

        function showAddSilver() {
            closeModal('portfolioModal');
            document.getElementById('addSilverModal').style.display = 'flex';
        }

        function addGold() {
            const amount = document.getElementById('goldAmount').value;
            const price = document.getElementById('goldPrice').value;

            if (!amount || !price) {
                tg.showAlert('Ù„Ø·ÙØ§Ù‹ Ù…Ù‚Ø¯Ø§Ø± Ùˆ Ù‚ÛŒÙ…Øª Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯');
                return;
            }

            const holding = {
                id: Date.now() + '-' + Math.random(),
                metal: 'gold',
                amount: parseFloat(amount),
                price: parseFloat(price),
                date: new Date().toISOString()
            };

            portfolio.holdings.push(holding);
            savePortfolio();

            document.getElementById('goldAmount').value = '';
            document.getElementById('goldPrice').value = '';

            closeModal('addGoldModal');
            showPortfolio();
        }

        function addSilver() {
            const amount = document.getElementById('silverAmount').value;
            const price = document.getElementById('silverBuyPrice').value;

            if (!amount || !price) {
                tg.showAlert('Ù„Ø·ÙØ§Ù‹ Ù…Ù‚Ø¯Ø§Ø± Ùˆ Ù‚ÛŒÙ…Øª Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯');
                return;
            }

            const holding = {
                id: Date.now() + '-' + Math.random(),
                metal: 'silver',
                amount: parseFloat(amount),
                price: parseFloat(price),
                date: new Date().toISOString()
            };

            portfolio.holdings.push(holding);
            savePortfolio();

            document.getElementById('silverAmount').value = '';
            document.getElementById('silverBuyPrice').value = '';

            closeModal('addSilverModal');
            showPortfolio();
        }

        function removeHolding(id) {
            portfolio.holdings = portfolio.holdings.filter(h => h.id !== id);
            savePortfolio();
            updateHoldingsList();
        }

        function clearPortfolio() {
            if (confirm('Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ù‡Ù…Ù‡ Ø¯Ø§Ø±Ø§ÛŒÛŒâ€ŒÙ‡Ø§ Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø¯Ø§Ø±ÛŒØ¯ØŸ')) {
                portfolio.holdings = [];
                savePortfolio();
                updateHoldingsList();
            }
        }

        // ==================== Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø³ÙˆØ¯/Ø²ÛŒØ§Ù† ====================
        function showProfit() {
            const modal = document.getElementById('profitModal');
            
            const goldProfit = calculateMetalProfit('gold');
            const silverProfit = calculateMetalProfit('silver');

            document.getElementById('profitGold').innerHTML = goldProfit || 'ğŸ… Ù‡ÛŒÚ† Ø¯Ø§Ø±Ø§ÛŒÛŒ Ø·Ù„Ø§ÛŒÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡';
            document.getElementById('profitSilver').innerHTML = silverProfit || 'ğŸ¥ˆ Ù‡ÛŒÚ† Ø¯Ø§Ø±Ø§ÛŒÛŒ Ù†Ù‚Ø±Ù‡â€ŒØ§ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡';

            modal.style.display = 'flex';
        }

        function calculateMetalProfit(metal) {
            const holdings = portfolio.holdings.filter(h => h.metal === metal);
            if (holdings.length === 0) return null;

            const totalAmount = holdings.reduce((sum, h) => sum + h.amount, 0);
            const totalCost = holdings.reduce((sum, h) => sum + (h.amount * h.price), 0);
            const avgPrice = totalCost / totalAmount;

            const currentPrice = metal === 'gold' ? lastPrices.gold : lastPrices.silver;
            if (!currentPrice) return 'âŒ Ù‚ÛŒÙ…Øª ÙØ¹Ù„ÛŒ Ø¯Ø± Ø¯Ø³ØªØ±Ø³ Ù†ÛŒØ³Øª';

            const currentValue = totalAmount * currentPrice;
            const commission = currentValue * 0.01;
            const netValue = currentValue - commission;
            const profit = netValue - totalCost;
            const profitPercent = (profit / totalCost) * 100;

            const metalName = metal === 'gold' ? 'Ø·Ù„Ø§' : 'Ù†Ù‚Ø±Ù‡';
            const sign = profit >= 0 ? 'ğŸŸ¢' : 'ğŸ”´';
            
            return `
                <div style="margin-bottom: 8px;"><b>${metal === 'gold' ? 'ğŸ…' : 'ğŸ¥ˆ'} ${metalName}</b></div>
                <div>Ù…Ù‚Ø¯Ø§Ø± Ú©Ù„: ${totalAmount.toLocaleString()} Ú¯Ø±Ù…</div>
                <div>Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ø®Ø±ÛŒØ¯: ${avgPrice.toLocaleString()} ØªÙˆÙ…Ø§Ù†</div>
                <div>Ù‚ÛŒÙ…Øª ÙØ¹Ù„ÛŒ: ${currentPrice.toLocaleString()} ØªÙˆÙ…Ø§Ù†</div>
                <div style="margin-top: 8px; font-weight: bold; color: ${profit >= 0 ? '#00a86b' : '#ff4d4d'}">
                    ${sign} ${profit >= 0 ? 'Ø³ÙˆØ¯' : 'Ø²ÛŒØ§Ù†'}: ${Math.abs(profit).toLocaleString()} ØªÙˆÙ…Ø§Ù† (${profitPercent.toFixed(2)}%)
                </div>
            `;
        }

        // ==================== Ù…Ø¯ÛŒØ±ÛŒØª Ù‡Ø´Ø¯Ø§Ø±Ù‡Ø§ ====================
        function showAlerts() {
            document.getElementById('goldMin').value = alerts.gold.min;
            document.getElementById('goldMax').value = alerts.gold.max;
            document.getElementById('goldEnabled').checked = alerts.gold.enabled;
            
            document.getElementById('silverMin').value = alerts.silver.min;
            document.getElementById('silverMax').value = alerts.silver.max;
            document.getElementById('silverEnabled').checked = alerts.silver.enabled;

            document.getElementById('alertsModal').style.display = 'flex';
        }

        function saveAlerts() {
            alerts.gold = {
                min: parseInt(document.getElementById('goldMin').value),
                max: parseInt(document.getElementById('goldMax').value),
                enabled: document.getElementById('goldEnabled').checked
            };
            
            alerts.silver = {
                min: parseInt(document.getElementById('silverMin').value),
                max: parseInt(document.getElementById('silverMax').value),
                enabled: document.getElementById('silverEnabled').checked
            };

            saveAlertsData();
            closeModal('alertsModal');
            tg.showAlert('âœ… ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ù‡Ø´Ø¯Ø§Ø± Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯');
        }

        // ==================== Ù…Ø¯ÛŒØ±ÛŒØª ØªÙ†Ø¸ÛŒÙ…Ø§Øª ====================
        function showSettings() {
            document.getElementById('reportInterval').value = settings.reportInterval;
            document.getElementById('reportType').value = settings.reportType;
            document.getElementById('settingsModal').style.display = 'flex';
        }

        function saveSettings() {
            settings.reportInterval = parseInt(document.getElementById('reportInterval').value);
            settings.reportType = document.getElementById('reportType').value;
            
            saveSettingsData();
            closeModal('settingsModal');
            
            if (window.updateInterval) {
                clearInterval(window.updateInterval);
            }
            window.updateInterval = setInterval(fetchPrices, settings.reportInterval * 60 * 1000);
            
            tg.showAlert('âœ… ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯');
        }

        // ==================== Ù…Ø¯ÛŒØ±ÛŒØª Ù…ÙˆØ¯Ø§Ù„â€ŒÙ‡Ø§ ====================
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        }

        function updateUI() {
            updatePriceDisplay();
        }

        // ==================== Ø´Ø±ÙˆØ¹ Ú©Ø§Ø± ====================
        loadData();
        fetchPrices();
        
        window.updateInterval = setInterval(fetchPrices, settings.reportInterval * 60 * 1000);

        tg.MainButton.setText("ğŸ“Š Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ");
        tg.MainButton.onClick(fetchPrices);
        tg.MainButton.show();

        tg.showPopup({
            title: 'ğŸ† Ø¨Ù‡ metals_dashboard Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯',
            message: 'Ø§ÛŒÙ† Ø§Ù¾Ù„ÛŒÚ©ÛŒØ´Ù† Ø¨Ù‡ Ø´Ù…Ø§ Ø§Ù…Ú©Ø§Ù† Ù¾Ø§ÛŒØ´ Ù„Ø­Ø¸Ù‡â€ŒØ§ÛŒ Ù‚ÛŒÙ…Øª Ø·Ù„Ø§ Ùˆ Ù†Ù‚Ø±Ù‡ØŒ Ù…Ø¯ÛŒØ±ÛŒØª Ù¾Ø±ØªÙÙˆÛŒ Ùˆ Ø¯Ø±ÛŒØ§ÙØª Ù‡Ø´Ø¯Ø§Ø± Ø±Ø§ Ù…ÛŒâ€ŒØ¯Ù‡Ø¯.',
            buttons: [{ type: 'ok' }]
        });
    </script>
</body>
</html>
