<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ† metals_dashboard</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: system-ui, -apple-system, sans-serif;
        }
        body {
            background: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            padding: 16px;
            max-width: 600px;
            margin: 0 auto;
        }
        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 24px;
        }
        .title {
            font-size: 24px;
            font-weight: bold;
        }
        .last-update {
            font-size: 12px;
            color: var(--tg-theme-hint-color, #999999);
        }
        .price-card {
            background: var(--tg-theme-secondary-bg-color, #f0f0f0);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 16px;
        }
        .price-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        .metal-name {
            font-size: 18px;
            font-weight: 600;
        }
        .price {
            font-size: 24px;
            font-weight: bold;
            direction: ltr;
        }
        .price-value {
            color: var(--tg-theme-text-color, #000000);
        }
        .price-value.loading {
            opacity: 0.5;
        }
        .change {
            font-size: 14px;
            padding: 4px 8px;
            border-radius: 20px;
        }
        .change.positive { background: #e6f7e6; color: #00a86b; }
        .change.negative { background: #ffe6e6; color: #ff4d4d; }
        
        .menu-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin: 24px 0;
        }
        .menu-item {
            background: var(--tg-theme-button-color, #40a7e3);
            color: var(--tg-theme-button-text-color, #ffffff);
            padding: 16px;
            border-radius: 14px;
            text-align: center;
            font-weight: 600;
            cursor: pointer;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .modal-content {
            background: var(--tg-theme-bg-color, #ffffff);
            border-radius: 24px;
            padding: 24px;
            width: 100%;
            max-width: 400px;
            max-height: 80vh;
            overflow-y: auto;
        }
        .input-group {
            margin-bottom: 16px;
        }
        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }
        .input-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--tg-theme-hint-color, #dddddd);
            border-radius: 12px;
            font-size: 16px;
            background: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
        }
        .button {
            background: var(--tg-theme-button-color, #40a7e3);
            color: var(--tg-theme-button-text-color, #ffffff);
            border: none;
            padding: 14px 24px;
            border-radius: 14px;
            font-weight: 600;
            font-size: 16px;
            width: 100%;
            cursor: pointer;
            margin-bottom: 8px;
        }
        .button.danger {
            background: #ff4d4d;
        }
        .holdings-list {
            margin: 16px 0;
        }
        .holding-item {
            background: var(--tg-theme-secondary-bg-color, #f0f0f0);
            padding: 12px;
            border-radius: 12px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .alert-message {
            background: #ffd700;
            color: #000;
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            text-align: center;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="header">
        <span class="title">ğŸ† metals_dashboard</span>
        <span class="last-update" id="lastUpdate">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ...</span>
    </div>

    <!-- Ú©Ø§Ø±Øªâ€ŒÙ‡Ø§ÛŒ Ù‚ÛŒÙ…Øª -->
    <div class="price-card" id="goldCard">
        <div class="price-row">
            <span class="metal-name">ğŸ… Ø·Ù„Ø§</span>
            <span class="change" id="goldChange">0%</span>
        </div>
        <div class="price-row">
            <span>Û²Û´ Ø¹ÛŒØ§Ø±</span>
            <span class="price">
                <span class="price-value" id="goldPrice24">---</span>
            </span>
        </div>
        <div class="price-row">
            <span>Û±Û¸ Ø¹ÛŒØ§Ø±</span>
            <span class="price">
                <span class="price-value" id="goldPrice18">---</span>
            </span>
        </div>
    </div>

    <div class="price-card" id="silverCard">
        <div class="price-row">
            <span class="metal-name">ğŸ¥ˆ Ù†Ù‚Ø±Ù‡</span>
            <span class="change" id="silverChange">0%</span>
        </div>
        <div class="price-row">
            <span>Ù‚ÛŒÙ…Øª</span>
            <span class="price">
                <span class="price-value" id="silverPrice">---</span>
            </span>
        </div>
    </div>

    <!-- Ù…Ù†ÙˆÛŒ Ø§ØµÙ„ÛŒ -->
    <div class="menu-grid">
        <div class="menu-item" onclick="showPortfolio()">ğŸ’¼ Ù¾Ø±ØªÙÙˆÛŒ</div>
        <div class="menu-item" onclick="showProfit()">ğŸ’° Ø³ÙˆØ¯/Ø²ÛŒØ§Ù†</div>
        <div class="menu-item" onclick="showAlerts()">ğŸ”” Ù‡Ø´Ø¯Ø§Ø±Ù‡Ø§</div>
        <div class="menu-item" onclick="showSettings()">âš™ï¸ ØªÙ†Ø¸ÛŒÙ…Ø§Øª</div>
    </div>

    <!-- Ù…ÙˆØ¯Ø§Ù„â€ŒÙ‡Ø§ Ø¨Ø§ Ø³Ø§Ø®ØªØ§Ø± Ù‚Ø¨Ù„ÛŒ ÙˆÙ„ÛŒ ØªÙˆØ§Ø¨Ø¹ Ø§ØµÙ„Ø§Ø­ Ø´Ø¯Ù‡ -->
    <div id="portfolioModal" class="modal">
        <div class="modal-content">
            <h2 style="margin-bottom: 20px;">ğŸ’¼ Ù…Ø¯ÛŒØ±ÛŒØª Ù¾Ø±ØªÙÙˆÛŒ</h2>
            <div class="menu-grid" style="grid-template-columns: 1fr 1fr; margin: 0 0 16px 0;">
                <div class="menu-item secondary" onclick="showAddGold()">â• Ø§ÙØ²ÙˆØ¯Ù† Ø·Ù„Ø§</div>
                <div class="menu-item secondary" onclick="showAddSilver()">â• Ø§ÙØ²ÙˆØ¯Ù† Ù†Ù‚Ø±Ù‡</div>
            </div>
            <div id="holdingsList" class="holdings-list"></div>
            <button class="button danger" onclick="clearPortfolio()">ğŸ—‘ Ø­Ø°Ù Ù‡Ù…Ù‡</button>
            <button class="button" onclick="closeModal('portfolioModal')">ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª</button>
        </div>
    </div>

    <!-- Ù…ÙˆØ¯Ø§Ù„ Ø§ÙØ²ÙˆØ¯Ù† Ø·Ù„Ø§ -->
    <div id="addGoldModal" class="modal">
        <div class="modal-content">
            <h2>â• Ø§ÙØ²ÙˆØ¯Ù† Ø·Ù„Ø§</h2>
            <div class="input-group">
                <label>Ù…Ù‚Ø¯Ø§Ø± (Ú¯Ø±Ù…)</label>
                <input type="number" id="goldAmount" placeholder="Ù…Ø«Ù„Ø§Ù‹ Û±Û°">
            </div>
            <div class="input-group">
                <label>Ù‚ÛŒÙ…Øª Ø®Ø±ÛŒØ¯ (ØªÙˆÙ…Ø§Ù†)</label>
                <input type="number" id="goldPrice" placeholder="Ù…Ø«Ù„Ø§Ù‹ Û³Û²Û°Û°Û°Û°Û°">
            </div>
            <button class="button" onclick="addGold()">âœ… Ø«Ø¨Øª</button>
            <button class="button secondary" onclick="closeModal('addGoldModal')">ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª</button>
        </div>
    </div>

    <!-- Ù…ÙˆØ¯Ø§Ù„ Ø§ÙØ²ÙˆØ¯Ù† Ù†Ù‚Ø±Ù‡ -->
    <div id="addSilverModal" class="modal">
        <div class="modal-content">
            <h2>â• Ø§ÙØ²ÙˆØ¯Ù† Ù†Ù‚Ø±Ù‡</h2>
            <div class="input-group">
                <label>Ù…Ù‚Ø¯Ø§Ø± (Ú¯Ø±Ù…)</label>
                <input type="number" id="silverAmount" placeholder="Ù…Ø«Ù„Ø§Ù‹ ÛµÛ°Û°">
            </div>
            <div class="input-group">
                <label>Ù‚ÛŒÙ…Øª Ø®Ø±ÛŒØ¯ (ØªÙˆÙ…Ø§Ù†)</label>
                <input type="number" id="silverBuyPrice" placeholder="Ù…Ø«Ù„Ø§Ù‹ Û´ÛµÛ°Û°Û°">
            </div>
            <button class="button" onclick="addSilver()">âœ… Ø«Ø¨Øª</button>
            <button class="button secondary" onclick="closeModal('addSilverModal')">ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª</button>
        </div>
    </div>

    <!-- Ù…ÙˆØ¯Ø§Ù„ Ø³ÙˆØ¯/Ø²ÛŒØ§Ù† -->
    <div id="profitModal" class="modal">
        <div class="modal-content">
            <h2>ğŸ’° Ú¯Ø²Ø§Ø±Ø´ Ø³ÙˆØ¯/Ø²ÛŒØ§Ù†</h2>
            <div id="profitGold" style="margin-bottom: 16px;"></div>
            <div id="profitSilver" style="margin-bottom: 16px;"></div>
            <button class="button" onclick="closeModal('profitModal')">ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª</button>
        </div>
    </div>

    <!-- Ù…ÙˆØ¯Ø§Ù„ Ù‡Ø´Ø¯Ø§Ø±Ù‡Ø§ -->
    <div id="alertsModal" class="modal">
        <div class="modal-content">
            <h2>ğŸ”” ØªÙ†Ø¸ÛŒÙ… Ù‡Ø´Ø¯Ø§Ø±</h2>
            <div style="margin-bottom: 20px;">
                <h3>ğŸ… Ø·Ù„Ø§</h3>
                <div class="input-group">
                    <label>Ø­Ø¯Ø§Ù‚Ù„ Ù‚ÛŒÙ…Øª</label>
                    <input type="number" id="goldMin" value="2000000">
                </div>
                <div class="input-group">
                    <label>Ø­Ø¯Ø§Ú©Ø«Ø± Ù‚ÛŒÙ…Øª</label>
                    <input type="number" id="goldMax" value="5000000">
                </div>
                <div style="display: flex; align-items: center;">
                    <input type="checkbox" id="goldEnabled" checked> <label>ÙØ¹Ø§Ù„ Ø¨Ø§Ø´Ø¯</label>
                </div>
            </div>
            <div style="margin-bottom: 20px;">
                <h3>ğŸ¥ˆ Ù†Ù‚Ø±Ù‡</h3>
                <div class="input-group">
                    <label>Ø­Ø¯Ø§Ù‚Ù„ Ù‚ÛŒÙ…Øª</label>
                    <input type="number" id="silverMin" value="30000">
                </div>
                <div class="input-group">
                    <label>Ø­Ø¯Ø§Ú©Ø«Ø± Ù‚ÛŒÙ…Øª</label>
                    <input type="number" id="silverMax" value="80000">
                </div>
                <div style="display: flex; align-items: center;">
                    <input type="checkbox" id="silverEnabled" checked> <label>ÙØ¹Ø§Ù„ Ø¨Ø§Ø´Ø¯</label>
                </div>
            </div>
            <button class="button" onclick="saveAlerts()">ğŸ’¾ Ø°Ø®ÛŒØ±Ù‡</button>
            <button class="button secondary" onclick="closeModal('alertsModal')">ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª</button>
        </div>
    </div>

    <!-- Ù…ÙˆØ¯Ø§Ù„ ØªÙ†Ø¸ÛŒÙ…Ø§Øª -->
    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <h2>âš™ï¸ ØªÙ†Ø¸ÛŒÙ…Ø§Øª</h2>
            <div class="input-group">
                <label>ÙØ§ØµÙ„Ù‡ Ú¯Ø²Ø§Ø±Ø´ (Ø¯Ù‚ÛŒÙ‚Ù‡)</label>
                <select id="reportInterval">
                    <option value="1">Û± Ø¯Ù‚ÛŒÙ‚Ù‡</option>
                    <option value="5" selected>Ûµ Ø¯Ù‚ÛŒÙ‚Ù‡</option>
                    <option value="10">Û±Û° Ø¯Ù‚ÛŒÙ‚Ù‡</option>
                    <option value="15">Û±Ûµ Ø¯Ù‚ÛŒÙ‚Ù‡</option>
                    <option value="30">Û³Û° Ø¯Ù‚ÛŒÙ‚Ù‡</option>
                </select>
            </div>
            <div class="input-group">
                <label>Ù†ÙˆØ¹ Ú¯Ø²Ø§Ø±Ø´</label>
                <select id="reportType">
                    <option value="both" selected>Ø·Ù„Ø§ Ùˆ Ù†Ù‚Ø±Ù‡</option>
                    <option value="gold">ÙÙ‚Ø· Ø·Ù„Ø§</option>
                    <option value="silver">ÙÙ‚Ø· Ù†Ù‚Ø±Ù‡</option>
                </select>
            </div>
            <button class="button" onclick="saveSettings()">ğŸ’¾ Ø°Ø®ÛŒØ±Ù‡</button>
            <button class="button secondary" onclick="closeModal('settingsModal')">ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª</button>
        </div>
    </div>

    <script>
        // ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø§ÙˆÙ„ÛŒÙ‡
        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.ready();

        // Ø°Ø®ÛŒØ±Ù‡â€ŒØ³Ø§Ø²ÛŒ Ù…Ø­Ù„ÛŒ
        let portfolio = JSON.parse(localStorage.getItem('portfolio') || '{"holdings":[]}');
        let alerts = JSON.parse(localStorage.getItem('alerts') || '{"gold":{"enabled":true,"min":2000000,"max":5000000},"silver":{"enabled":true,"min":30000,"max":80000}}');
        let settings = JSON.parse(localStorage.getItem('settings') || '{"reportInterval":5,"reportType":"both"}');
        let lastPrices = { gold: null, silver: null };

        // ØªØ§Ø¨Ø¹ Ù†Ù…Ø§ÛŒØ´ Ù¾ÛŒØ§Ù… (Ø¨Ø¯ÙˆÙ† showPopup)
        function showMessage(text) {
            const msgDiv = document.createElement('div');
            msgDiv.className = 'alert-message';
            msgDiv.textContent = text;
            document.body.insertBefore(msgDiv, document.body.firstChild);
            setTimeout(() => msgDiv.remove(), 3000);
        }

        // Ø¯Ø±ÛŒØ§ÙØª Ù‚ÛŒÙ…Øª Ø§Ø² API Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†
        async function fetchPrices() {
            try {
                // Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² JSONP ÛŒØ§ API Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†
                const response = await fetch('https://api.navasan.tech/latest/?api_key=free');
                const data = await response.json();
                
                if (data.gold_18k?.value) {
                    const price24 = Math.round(parseFloat(data.gold_18k.value) * 1.333);
                    lastPrices.gold = price24;
                    
                    document.getElementById('goldPrice24').innerText = price24.toLocaleString();
                    document.getElementById('goldPrice18').innerText = Math.round(price24 * 0.75).toLocaleString();
                }
                
                if (data.silver?.value) {
                    lastPrices.silver = Math.round(parseFloat(data.silver.value));
                    document.getElementById('silverPrice').innerText = lastPrices.silver.toLocaleString();
                }
                
                document.getElementById('lastUpdate').innerText = 'Ø¢Ø®Ø±ÛŒÙ† Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ: ' + new Date().toLocaleTimeString('fa-IR');
                
            } catch (error) {
                // Ø§Ú¯Ø± API Ø§ÙˆÙ„ Ú©Ø§Ø± Ù†Ú©Ø±Ø¯ØŒ Ø§Ø² API Ø¯ÙˆÙ… Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†
                try {
                    const response = await fetch('https://api.tgju.online/v1/data/price');
                    const data = await response.json();
                    
                    if (data.gold?.price) {
                        lastPrices.gold = data.gold.price;
                        document.getElementById('goldPrice24').innerText = lastPrices.gold.toLocaleString();
                        document.getElementById('goldPrice18').innerText = Math.round(lastPrices.gold * 0.75).toLocaleString();
                    }
                    
                    document.getElementById('lastUpdate').innerText = 'Ø¢Ø®Ø±ÛŒÙ† Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ: ' + new Date().toLocaleTimeString('fa-IR');
                    
                } catch (error2) {
                    document.getElementById('lastUpdate').innerText = 'âš ï¸ Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª';
                    showMessage('Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±');
                }
            }
        }

        // Ù…Ø¯ÛŒØ±ÛŒØª Ù¾Ø±ØªÙÙˆÛŒ
        function showPortfolio() {
            updateHoldingsList();
            document.getElementById('portfolioModal').style.display = 'flex';
        }

        function updateHoldingsList() {
            const list = document.getElementById('holdingsList');
            if (portfolio.holdings.length === 0) {
                list.innerHTML = '<p style="text-align:center">Ù¾Ø±ØªÙÙˆÛŒ Ø®Ø§Ù„ÛŒ Ø§Ø³Øª</p>';
                return;
            }
            
            list.innerHTML = portfolio.holdings.map(h => `
                <div class="holding-item">
                    <div>${h.metal === 'gold' ? 'ğŸ…' : 'ğŸ¥ˆ'} ${h.amount}g @ ${h.price.toLocaleString()}</div>
                    <button onclick="removeHolding('${h.id}')" style="background:none;border:none;color:#ff4d4d;font-size:20px;">ğŸ—‘</button>
                </div>
            `).join('');
        }

        function showAddGold() {
            closeModal('portfolioModal');
            document.getElementById('addGoldModal').style.display = 'flex';
        }

        function showAddSilver() {
            closeModal('portfolioModal');
            document.getElementById('addSilverModal').style.display = 'flex';
        }

        function addGold() {
            const amount = document.getElementById('goldAmount').value;
            const price = document.getElementById('goldPrice').value;
            
            if (!amount || !price) {
                showMessage('Ù„Ø·ÙØ§Ù‹ Ù‡Ù…Ù‡ ÙÛŒÙ„Ø¯Ù‡Ø§ Ø±Ø§ Ù¾Ø± Ú©Ù†ÛŒØ¯');
                return;
            }
            
            portfolio.holdings.push({
                id: Date.now() + '-' + Math.random(),
                metal: 'gold',
                amount: parseFloat(amount),
                price: parseFloat(price)
            });
            
            localStorage.setItem('portfolio', JSON.stringify(portfolio));
            closeModal('addGoldModal');
            showPortfolio();
        }

        function addSilver() {
            const amount = document.getElementById('silverAmount').value;
            const price = document.getElementById('silverBuyPrice').value;
            
            if (!amount || !price) {
                showMessage('Ù„Ø·ÙØ§Ù‹ Ù‡Ù…Ù‡ ÙÛŒÙ„Ø¯Ù‡Ø§ Ø±Ø§ Ù¾Ø± Ú©Ù†ÛŒØ¯');
                return;
            }
            
            portfolio.holdings.push({
                id: Date.now() + '-' + Math.random(),
                metal: 'silver',
                amount: parseFloat(amount),
                price: parseFloat(price)
            });
            
            localStorage.setItem('portfolio', JSON.stringify(portfolio));
            closeModal('addSilverModal');
            showPortfolio();
        }

        function removeHolding(id) {
            portfolio.holdings = portfolio.holdings.filter(h => h.id !== id);
            localStorage.setItem('portfolio', JSON.stringify(portfolio));
            updateHoldingsList();
        }

        function clearPortfolio() {
            if (confirm('Ø­Ø°Ù Ù‡Ù…Ù‡ØŸ')) {
                portfolio.holdings = [];
                localStorage.setItem('portfolio', JSON.stringify(portfolio));
                updateHoldingsList();
            }
        }

        // Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø³ÙˆØ¯/Ø²ÛŒØ§Ù†
        function showProfit() {
            const goldProfit = calculateProfit('gold');
            const silverProfit = calculateProfit('silver');
            
            document.getElementById('profitGold').innerHTML = goldProfit || 'ğŸ… Ù‡ÛŒÚ† Ø·Ù„Ø§ÛŒÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡';
            document.getElementById('profitSilver').innerHTML = silverProfit || 'ğŸ¥ˆ Ù‡ÛŒÚ† Ù†Ù‚Ø±Ù‡â€ŒØ§ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡';
            
            document.getElementById('profitModal').style.display = 'flex';
        }

        function calculateProfit(metal) {
            const holdings = portfolio.holdings.filter(h => h.metal === metal);
            if (holdings.length === 0) return null;
            
            const totalAmount = holdings.reduce((sum, h) => sum + h.amount, 0);
            const totalCost = holdings.reduce((sum, h) => sum + (h.amount * h.price), 0);
            const avgPrice = totalCost / totalAmount;
            const currentPrice = metal === 'gold' ? lastPrices.gold : lastPrices.silver;
            
            if (!currentPrice) return 'âŒ Ù‚ÛŒÙ…Øª ÙØ¹Ù„ÛŒ Ø¯Ø± Ø¯Ø³ØªØ±Ø³ Ù†ÛŒØ³Øª';
            
            const currentValue = totalAmount * currentPrice;
            const commission = currentValue * 0.01;
            const netValue = currentValue - commission;
            const profit = netValue - totalCost;
            const profitPercent = (profit / totalCost) * 100;
            
            return `
                <div><b>${metal === 'gold' ? 'ğŸ…' : 'ğŸ¥ˆ'} ${metal === 'gold' ? 'Ø·Ù„Ø§' : 'Ù†Ù‚Ø±Ù‡'}</b></div>
                <div>Ù…Ù‚Ø¯Ø§Ø±: ${totalAmount.toLocaleString()} Ú¯Ø±Ù…</div>
                <div>Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ø®Ø±ÛŒØ¯: ${avgPrice.toLocaleString()}</div>
                <div>Ù‚ÛŒÙ…Øª ÙØ¹Ù„ÛŒ: ${currentPrice.toLocaleString()}</div>
                <div style="color:${profit >= 0 ? '#00a86b' : '#ff4d4d'}">
                    ${profit >= 0 ? 'ğŸŸ¢ Ø³ÙˆØ¯' : 'ğŸ”´ Ø²ÛŒØ§Ù†'}: ${Math.abs(profit).toLocaleString()} (${profitPercent.toFixed(2)}%)
                </div>
            `;
        }

        // Ù…Ø¯ÛŒØ±ÛŒØª Ù‡Ø´Ø¯Ø§Ø±Ù‡Ø§
        function showAlerts() {
            document.getElementById('goldMin').value = alerts.gold.min;
            document.getElementById('goldMax').value = alerts.gold.max;
            document.getElementById('goldEnabled').checked = alerts.gold.enabled;
            document.getElementById('silverMin').value = alerts.silver.min;
            document.getElementById('silverMax').value = alerts.silver.max;
            document.getElementById('silverEnabled').checked = alerts.silver.enabled;
            document.getElementById('alertsModal').style.display = 'flex';
        }

        function saveAlerts() {
            alerts.gold = {
                min: parseInt(document.getElementById('goldMin').value),
                max: parseInt(document.getElementById('goldMax').value),
                enabled: document.getElementById('goldEnabled').checked
            };
            alerts.silver = {
                min: parseInt(document.getElementById('silverMin').value),
                max: parseInt(document.getElementById('silverMax').value),
                enabled: document.getElementById('silverEnabled').checked
            };
            localStorage.setItem('alerts', JSON.stringify(alerts));
            closeModal('alertsModal');
            showMessage('âœ… ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯');
        }

        // Ù…Ø¯ÛŒØ±ÛŒØª ØªÙ†Ø¸ÛŒÙ…Ø§Øª
        function showSettings() {
            document.getElementById('reportInterval').value = settings.reportInterval;
            document.getElementById('reportType').value = settings.reportType;
            document.getElementById('settingsModal').style.display = 'flex';
        }

        function saveSettings() {
            settings.reportInterval = parseInt(document.getElementById('reportInterval').value);
            settings.reportType = document.getElementById('reportType').value;
            localStorage.setItem('settings', JSON.stringify(settings));
            closeModal('settingsModal');
            
            if (window.updateInterval) clearInterval(window.updateInterval);
            window.updateInterval = setInterval(fetchPrices, settings.reportInterval * 60 * 1000);
            showMessage('âœ… ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯');
        }

        // Ù…Ø¯ÛŒØ±ÛŒØª Ù…ÙˆØ¯Ø§Ù„â€ŒÙ‡Ø§
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        window.onclick = (event) => {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        };

        // Ø´Ø±ÙˆØ¹ Ú©Ø§Ø±
        fetchPrices();
        window.updateInterval = setInterval(fetchPrices, settings.reportInterval * 60 * 1000);

        // Ø¯Ú©Ù…Ù‡ Ø§ØµÙ„ÛŒ ØªÙ„Ú¯Ø±Ø§Ù…
        tg.MainButton.setText("ğŸ“Š Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ");
        tg.MainButton.onClick(fetchPrices);
        tg.MainButton.show();

        // Ù¾ÛŒØ§Ù… Ø®ÙˆØ´â€ŒØ¢Ù…Ø¯ (Ø¨Ø¯ÙˆÙ† showPopup)
        setTimeout(() => {
            showMessage('Ø¨Ù‡ metals_dashboard Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯');
        }, 500);
    </script>
</body>
</html>
